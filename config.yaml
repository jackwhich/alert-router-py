server:
  host: 0.0.0.0
  port: 8080

logging:
  log_dir: "logs"
  log_file: "alert-router.log"
  level: "INFO"
  max_bytes: 10485760
  backup_count: 5

# 全局代理开关（控制是否使用代理）
# true: 启用代理（默认）
# false: 禁用代理（所有渠道都不使用代理）
proxy_enabled: true

proxy:
  http: "socks5://10.8.16.64:13080"
  https: "socks5://10.8.16.64:13080"

# Prometheus 告警图片渲染
prometheus_image:
  enabled: true
  # Prometheus API 地址，例如: http://prometheus:9090，如果为空则从 generatorURL 解析
  prometheus_url: ""
  # 图片生成是否使用代理（默认 false，因为 Prometheus 通常是内网地址）
  use_proxy: false
  # 绘图引擎: "matplotlib" 中文显示稳定；"plotly" 更美观但 Kaleido 可能无法使用系统中文字体导致中文变方框
  # 若 Plotly 下中文显示为方框，可改回 matplotlib
  plot_engine: "matplotlib"
  lookback_minutes: 15
  step: "30s"
  timeout_seconds: 8
  max_series: 8
  # 图例标签白名单：仅以下 label 会显示在趋势图图例中，不在此列表的一律不显示
  # 按类型分组便于维护；未命中 profile 时使用此默认列表（已对照 dc-prometheus 规则补全）
  legend_label_whitelist:
    # K8s/容器
    - pod
    - container
    - namespace
    - deployment
    - statefulset
    - daemonset
    - job_name
    - horizontalpodautoscaler
    - persistentvolumeclaim
    - persistentvolume
    - phase
    # 节点/磁盘
    - device
    - mountpoint
    - fstype
    - instance
    - node
    # Kafka（积压/分区数/broker/副本 等）
    - topic
    - consumergroup
    - name
    - address
    # RocketMQ（积压/消费延时/broker/TPS 等）
    - group
    - broker
    - brokerIP
    - cluster
    - env
    # RPC/服务/Dubbo/Hikaricp
    - service_name
    - endpoint
    - application
    # Jenkins
    - jenkins_job
    - build_number
    # Nginx（4XX/5XX/uri/源IP 等）
    - server_name
    - status
    - uri
    - request_uri
    - remote_addr
    - url
    # Prometheus/Alertmanager
    - alertmanager
    - remote_name
    - controller
    - resource
    # Nacos（节点宕机/CPU 等，nacos_monitor 用 name、kubernetes_namespace）
    - kubernetes_namespace
    # 通用/TargetDown 等
    - service

# Grafana 告警图片渲染
grafana_image:
  enabled: true
  # Grafana 地址，例如: http://grafana:3000（可选，如果未配置会从 generatorURL 自动提取）
  # 用于调用 Grafana 渲染服务生成图片（需要 Grafana 配置了渲染服务）
  grafana_url: ""
  # Prometheus API 地址，例如: http://prometheus:9090（可选，仅当 Grafana 使用 Prometheus 数据源时需要）
  # 如果未配置，将使用 Grafana 渲染服务生成图片
  # prometheus_url: ""
  # 图片生成是否使用代理（默认 false，因为 Grafana/Prometheus 通常是内网地址）
  use_proxy: false
  lookback_minutes: 15
  step: "30s"
  timeout_seconds: 8
  max_series: 8

jenkins_dedup:
  enabled: true
  ttl_seconds: 900
  clear_on_resolved: true

defaults:
  title_prefix: "[ALERT]"
  dashboard_fallback: ""
  runbook_fallback: ""

# 渠道配置说明：命名规范 = 来源_渠道_用途
# - 来源：prometheus、grafana（谁发的告警）
# - 渠道：telegram、slack（发到哪里）
# - 用途：default、critical、warning、jenkins 等

channels:
  # Prometheus 告警渠道
  prometheus_telegram_default:
    type: telegram
    enabled: true
    image_enabled: true
    bot_token: "8502571186:xxxxx"
    chat_id: "-5134533386"
    template: "prometheus_telegram.html.j2"

  prometheus_telegram_critical:
    type: telegram
    enabled: false
    image_enabled: false
    bot_token: "123456:AAxxxx"
    chat_id: "-1001234567890"
    template: "prometheus_telegram.html.j2"

  prometheus_slack:
    type: slack
    enabled: true
    webhook_url: "https://hooks.slack.com/services/T000/B000/XXX"
    template: "prometheus_slack.json.j2"

  # Grafana 告警渠道
  grafana_telegram_default:
    type: telegram
    enabled: true
    image_enabled: true
    bot_token: "8502571186:xxxxx"
    chat_id: "-5134533386"
    template: "grafana_telegram.html.j2"

  grafana_telegram_critical:
    type: telegram
    enabled: false
    image_enabled: false
    bot_token: "8502571186:xxxxx"
    chat_id: "-5134533386"
    template: "grafana_telegram.html.j2"

  grafana_slack:
    type: slack
    enabled: false
    webhook_url: "https://hooks.slack.com/services/T000/B000/YYY"
    template: "grafana_slack.json.j2"

  # Jenkins 告警渠道
  prometheus_telegram_jenkins:
    # Jenkins 渠道关闭趋势图
    # Jenkins 告警只发送 firing，不发送 resolved
    type: telegram
    enabled: true
    image_enabled: false
    bot_token: "8502571186:xxxxx"
    chat_id: "-5134533386"
    template: "prometheus_telegram_jenkins.html.j2"
    send_resolved: false

# 路由：所有告警发默认渠道；severity=critical/灾难 时额外发灾难渠道（共 2 个渠道）
routing:
  # Jenkins 告警（Prometheus 来源）走专用模板/群组
  - match:
      _source: "prometheus"
      _receiver: "Prometheus"
    send_to: ["prometheus_telegram_default"]

  # 告警来源 = Prometheus（支持 critical 或 灾难）
  - match:
      _source: "prometheus"
      alertname: "^(?!Jenkins|jenkins).*"
      severity: "critical|灾难"
    send_to: ["prometheus_telegram_critical"]

  - match:
      _source: "prometheus"
      _receiver: "prod_ebpay_jenkins_alarm"
      alertname: ".*Jenkins.*|.*jenkins.*"
    send_to: ["prometheus_telegram_jenkins"]

  # 告警来源 = Grafana（支持 critical 或 灾难）
  - match:
      _source: "grafana"
      severity: "critical|灾难"
    send_to: ["grafana_telegram_critical"]

  - match:
      _source: "grafana"
    send_to: ["grafana_telegram_default"]

